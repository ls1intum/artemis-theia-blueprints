# syntax=docker/dockerfile:1
#
# This Dockerfile is used to build an image containing basic Theia application with OCaml support
# The ocaml compiler `ocamlc` and the package manager `opam` are installed
# However, for `opam` to work properly, it needs to be initialized in every terminal session
# This can be done by running `eval $(opam env)` in the terminal, automation of this step was not yet successful
# ItÂ´s unclear from which `.profile` or `.bashrc` file the terminal starts in Theia
#

# Load the base-ide image, only copy from here
ARG BASE_IDE_TAG=latest
ARG BASE_IMAGE=ghcr.io/ls1intum/theia/base:${BASE_IDE_TAG}
FROM ${BASE_IMAGE} AS base-ide

# Parallel stage: Install system dependencies (runs concurrently with plugin-image)
FROM node:22-bullseye-slim AS apt-deps

WORKDIR /home/theia

# Create theia user and directories
RUN adduser --system --group theia --uid 101 && \
    chmod g+rw /home && \
    mkdir -p /home/project && \
    chown -R theia:theia /home/theia && \
    chown -R theia:theia /home/project

ENV HOME=/home/theia

# Install all system dependencies with BuildKit cache mounts
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && \
    apt-get install -y --no-install-recommends \
    wget apt-transport-https bash git curl m4 tzdata opam ocaml ca-certificates

# Parallel stage: Plugin download (runs concurrently with apt-deps)
FROM node:22-bullseye AS plugin-image

WORKDIR /home/theia

# Configure to skip download of puppeteer
ENV PUPPETEER_SKIP_DOWNLOAD=true

# Install jq for JSON merging
RUN apt-get update && apt-get install -y --no-install-recommends jq && rm -rf /var/lib/apt/lists/*

# Copy required configuration files
COPY --from=base-ide /home/theia/package.json ./package.json.base
COPY images/ocaml/package.json.patch ./package.json.patch

# Merge the base package.json with the ocaml-specific patch using jq
RUN jq -s '.[0] * .[1]' package.json.base package.json.patch > package.json && \
    rm package.json.base package.json.patch

# Copy from base-ide: scripts, configs, existing plugins, and production node_modules
COPY --from=base-ide /home/theia/scripts /home/theia/scripts
COPY --from=base-ide /home/theia/configs /home/theia/configs
COPY --from=base-ide /home/theia/tsconfig.json /home/theia/tsconfig.json
COPY --from=base-ide /home/theia/plugins /home/theia/plugins
COPY --from=base-ide /home/theia/node_modules /home/theia/node_modules

# Install ONLY @theia/cli (needed for download:plugins command)
RUN yarn add -W @theia/cli@1.62.2 --network-timeout 1000000

# Download language-specific plugins
RUN yarn download:plugins

# Final stage: Assemble the application
FROM apt-deps AS final-ide

# Initialize opam environment for the non-root user (theia)
USER theia
RUN opam init --disable-sandboxing -y && \
    opam install dune.3.19.1 -y && \
    opam install qcheck ocaml-lsp-server odoc ocamlformat utop user-setup -y && \
    opam env --switch default --shell=sh > /home/theia/.opam/opam.sh

# Change to root to copy opam.sh to /etc/profile.d for global availability
USER root
RUN install -m 644 /home/theia/.opam/opam.sh /etc/profile.d/opam.sh && \
    chown root:root /etc/profile.d/opam.sh

USER theia
ENV HOME=/home/theia
WORKDIR /home/theia

# Create .ocamlformat file inside project's root directory for ocamlformat to work
RUN touch /home/project/.ocamlformat

# Copy application from base-ide (includes prod node_modules)
COPY --from=base-ide --chown=theia:theia /home/theia /home/theia

# Copy additional plugins (language-specific extensions)
COPY --from=plugin-image --chown=theia:theia /home/theia/plugins /home/theia/plugins

# Copy project settings (includes .theia/settings.json with file exclusions)
COPY --chown=theia:theia images/ocaml/project /home/project

EXPOSE 3000

# Specify default shell for Theia and the Built-In plugins directory
ENV SHELL=/bin/bash \
    THEIA_DEFAULT_PLUGINS=local-dir:/home/theia/plugins

# Use installed git instead of dugite
ENV USE_LOCAL_GIT=true

WORKDIR /home/theia/applications/browser

# Launch the backend application via node
ENTRYPOINT [ "node", "/home/theia/applications/browser/lib/backend/main.js" ]

# Arguments passed to the application
CMD [ "/home/project", "--hostname=0.0.0.0" ]
