# syntax=docker/dockerfile:1
# Load the base-ide image, only copy from here
ARG BASE_IDE_TAG=latest
ARG BASE_IMAGE=ghcr.io/ls1intum/theia/base:${BASE_IDE_TAG}
FROM ${BASE_IMAGE} AS base-ide

# Parallel stage: Install system dependencies (runs concurrently with plugin-image)
FROM ubuntu:24.04 AS apt-deps

WORKDIR /home/theia

# Install all system dependencies with BuildKit cache mounts (including adduser)
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && \
    apt-get upgrade -y --autoremove && \
    apt-get install -y --no-install-recommends \
    curl adduser build-essential bash zsh git ca-certificates

# Create theia user and directories (after adduser is installed)
RUN useradd --system --create-home --user-group --uid 101 theia && \
    chmod g+rw /home && \
    mkdir -p /home/project && \
    chown -R theia:theia /home/theia && \
    chown -R theia:theia /home/project

# Parallel stage: Plugin download (runs concurrently with apt-deps)
FROM node:22-bullseye AS plugin-image

WORKDIR /home/theia

# Configure to skip download of puppeteer
ENV PUPPETEER_SKIP_DOWNLOAD=true

# Copy required configuration files
COPY --from=base-ide /home/theia/package.json ./package.json.base
COPY images/rust/package.json.patch ./package.json.patch

# Merge the base package.json with the rust-specific patch using Node.js
RUN node -e "const fs=require('fs'); const deepMerge=(t,s)=>{const o={...t}; for(const k in s){o[k]=s[k]!==null&&typeof s[k]==='object'&&!Array.isArray(s[k])&&t[k]?deepMerge(t[k],s[k]):s[k]} return o}; const base=JSON.parse(fs.readFileSync('package.json.base')); const patch=JSON.parse(fs.readFileSync('package.json.patch')); fs.writeFileSync('package.json', JSON.stringify(deepMerge(base,patch), null, 2));" && \
    rm package.json.base package.json.patch

# Copy from base-ide: scripts, configs, existing plugins, and production node_modules
COPY --from=base-ide /home/theia/scripts /home/theia/scripts
COPY --from=base-ide /home/theia/configs /home/theia/configs
COPY --from=base-ide /home/theia/tsconfig.json /home/theia/tsconfig.json
COPY --from=base-ide /home/theia/plugins /home/theia/plugins
COPY --from=base-ide /home/theia/node_modules /home/theia/node_modules

# Install ONLY @theia/cli (needed for download:plugins command)
RUN yarn add -W @theia/cli@1.68.2 --network-timeout 1000000

# Download language-specific plugins
RUN yarn download:plugins

# Final stage: Assemble the application
FROM apt-deps AS final-ide

# Copy node binary from plugin-image (required for Theia runtime)
COPY --from=plugin-image /usr/local/bin/node /usr/local/bin/

ENV HOME=/home/theia
WORKDIR /home/theia

# Copy application from base-ide (includes prod node_modules)
COPY --from=base-ide --chown=theia:theia /home/theia /home/theia

# Copy additional plugins (language-specific extensions)
COPY --from=plugin-image --chown=theia:theia /home/theia/plugins /home/theia/plugins

# Copy project settings (includes .vscode/settings.json with file exclusions)
COPY --chown=theia:theia images/rust/project /home/project

EXPOSE 3000

# Specify default shell for Theia and the Built-In plugins directory
ENV SHELL=/bin/zsh \
    THEIA_DEFAULT_PLUGINS=local-dir:/home/theia/plugins

# Use installed git instead of dugite
ENV USE_LOCAL_GIT=true

# Switch to Theia user
USER theia

# Install Oh My Zsh and plugins with pinned versions
RUN git clone --depth 1 --branch master https://github.com/ohmyzsh/ohmyzsh.git ${HOME}/.oh-my-zsh && \
    git clone --depth 1 --branch v0.7.1 https://github.com/zsh-users/zsh-autosuggestions ${HOME}/.oh-my-zsh/custom/plugins/zsh-autosuggestions && \
    git clone --depth 1 --branch 0.8.0 https://github.com/zsh-users/zsh-syntax-highlighting.git ${HOME}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting

# Copy centralized zsh configuration
COPY --chown=theia:theia configs/zshrc ${HOME}/.zshrc

# Install Rust with minimal profile and cleanup
# Replace bundled rust-analyzer server with rustup version to ensure
# proc-macro API version compatibility with the Rust toolchain
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs --output rust.sh \
    && chmod +x rust.sh \
    && ./rust.sh -y --profile minimal \
    && rm rust.sh \
    && . "$HOME/.cargo/env" \
    && rustup component add rust-analyzer \
    && cp /home/theia/.cargo/bin/rust-analyzer /home/theia/plugins/rust-analyzer/extension/server/rust-analyzer \
    && rm -rf $HOME/.cargo/registry \
    && rm -rf $HOME/.cargo/git \
    && rm -rf $HOME/.rustup/downloads \
    && rm -rf $HOME/.rustup/toolchains/*/share/doc

# Add Rust to the global PATH for all users
ENV PATH=/home/theia/.cargo/bin:$PATH

# Ensure the environment is set correctly when switching to the user "theia"
RUN echo 'source $HOME/.cargo/env' >> /home/theia/.zshrc

WORKDIR /home/theia/applications/browser

# Launch the backend application via node
ENTRYPOINT [ "node", "/home/theia/applications/browser/lib/backend/main.js" ]

# Arguments passed to the application
CMD [ "/home/project", "--hostname=0.0.0.0" ]
