# Load the plugin image, only copy from here
FROM node:20-bullseye AS base-theia-lite

# install required tools to build the application
RUN apt-get update && apt-get install -y libxkbfile-dev libsecret-1-dev

WORKDIR /home/theia

# Configure to skip download of puppeteer
ENV PUPPETEER_SKIP_DOWNLOAD=true

# Copy required configuration files
COPY yarn.lock yarn.lock
COPY package.json package.json
COPY tsconfig.json tsconfig.json
COPY lerna.json lerna.json
COPY configs configs

# Copy Browser Application (and electron but it will be removed later)
COPY applications applications

# Copy Theia Extensions (launcher, opfs, product, updater)
COPY theia-extensions theia-extensions

# Remove unnecesarry files for the browser application
# Download plugins and build application production mode
# Use yarn autoclean to remove unnecessary files from package dependencies
RUN yarn --pure-lockfile --network-timeout 1000000
RUN yarn autoclean --init && \
    echo *.ts >> .yarnclean && \
    echo *.ts.map >> .yarnclean && \
    echo *.spec.* >> .yarnclean

RUN yarn build:extensions
RUN yarn browser-only build

RUN yarn autoclean --force && \
    yarn cache clean && \
    rm -r theia-extensions/launcher theia-extensions/updater node_modules

# Load the plugin image, only copy from here
FROM node:20-bullseye AS plugin-image

# Copy required configuration files
COPY yarn.lock yarn.lock

# Copy image specific files - this should overwrite the default files from the repository
COPY images/theia-lite/package.json .

RUN yarn --pure-lockfile --network-timeout 1000000 && \
    yarn download:plugins

COPY scripts/prepare-plugins.js .
RUN node prepare-plugins.js

# Assemble the application
FROM nginx:alpine AS final-ide

# Copy IDE files
COPY --from=base-theia-lite /home/theia/applications/browser-only/lib/frontend /usr/share/nginx/html

# Copy plugins
COPY --from=plugin-image /hostedPlugin /usr/share/nginx/html/hostedPlugin

RUN mkdir -p /var/cache/nginx /var/run /var/log/nginx /tmp/nginx && \
    chmod -R 777 /var/cache/nginx /var/run /var/log/nginx /tmp/nginx /usr/share/nginx/html && \
    chown -R nginx:nginx /var/cache/nginx /var/run /var/log/nginx /tmp/nginx /usr/share/nginx/html && \
    sed -i 's/user nginx/user nginx nginx/g' /etc/nginx/nginx.conf && \
    sed -i 's!pid /var/run/nginx.pid!pid /tmp/nginx/nginx.pid!g' /etc/nginx/nginx.conf && \
    sed -i '/http {/a\\    gzip on;\n    gzip_vary on;\n    gzip_min_length 1024;\n    gzip_proxied any;\n    gzip_comp_level 6;\n    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json application/wasm;' /etc/nginx/nginx.conf

# Create a custom nginx config that supports environment variables
RUN echo 'server {' > /etc/nginx/conf.d/default.conf && \
    echo '    listen 3000;' >> /etc/nginx/conf.d/default.conf && \
    echo '    server_name localhost;' >> /etc/nginx/conf.d/default.conf && \
    echo '' >> /etc/nginx/conf.d/default.conf && \
    echo '    location /git-url {' >> /etc/nginx/conf.d/default.conf && \
    echo '        add_header Content-Type text/plain;' >> /etc/nginx/conf.d/default.conf && \
    echo '        return 200 "${GIT_URI}";' >> /etc/nginx/conf.d/default.conf && \
    echo '    }' >> /etc/nginx/conf.d/default.conf && \
    echo '' >> /etc/nginx/conf.d/default.conf && \
    echo '    location / {' >> /etc/nginx/conf.d/default.conf && \
    echo '        root /usr/share/nginx/html;' >> /etc/nginx/conf.d/default.conf && \
    echo '    }' >> /etc/nginx/conf.d/default.conf && \
    echo '}' >> /etc/nginx/conf.d/default.conf

# Create a startup script that will substitute environment variables
RUN echo '#!/bin/sh' > /docker-entrypoint-wrapper.sh && \
    echo 'envsubst < /etc/nginx/conf.d/default.conf > /etc/nginx/conf.d/default.conf.tmp' >> /docker-entrypoint-wrapper.sh && \
    echo 'mv /etc/nginx/conf.d/default.conf.tmp /etc/nginx/conf.d/default.conf' >> /docker-entrypoint-wrapper.sh && \
    echo 'exec /docker-entrypoint.sh "$@"' >> /docker-entrypoint-wrapper.sh && \
    chmod +x /docker-entrypoint-wrapper.sh

EXPOSE 3000

# Use custom entrypoint that handles environment variable substitution
ENTRYPOINT ["/docker-entrypoint-wrapper.sh"]
CMD ["nginx", "-g", "daemon off;"]

# EXPOSE 80