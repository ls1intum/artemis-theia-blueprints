# Swift requires builder and runtime images overwritten by workflow
ARG BUILDER_IMAGE=swift:focal
ARG RUNTIME_IMAGE=swift:focal

# Load the base-ide image, only copy from here
ARG BASE_IDE_TAG=latest
ARG BASE_IMAGE=ghcr.io/ls1intum/theia/base:${BASE_IDE_TAG}
FROM ${BASE_IMAGE} AS base-ide

# Load the plugin image, only copy from here
FROM node:22-bullseye AS plugin-image

WORKDIR /home/theia

# Configure to skip download of puppeteer
ENV PUPPETEER_SKIP_DOWNLOAD=true

# Install jq for JSON merging
RUN apt-get update && apt-get install -y --no-install-recommends jq && rm -rf /var/lib/apt/lists/*

# Copy required configuration files
COPY --from=base-ide /home/theia/package.json ./package.json.base
COPY images/swift/package.json.patch ./package.json.patch

# Merge the base package.json with the swift-specific patch using jq
RUN jq -s '.[0] + .[1]' package.json.base package.json.patch > package.json
RUN rm package.json.base package.json.patch

# Copy scripts and dependencies from base-ide needed for yarn commands
COPY --from=base-ide /home/theia/scripts /home/theia/scripts
COPY --from=base-ide /home/theia/configs /home/theia/configs
COPY --from=base-ide /home/theia/tsconfig.json /home/theia/tsconfig.json
COPY --from=base-ide /home/theia/plugins /home/theia/plugins

# Remove unnecessary files for the browser application
# Download plugins and build application production mode
# Use yarn autoclean to remove unnecessary files from package dependencies
RUN yarn --pure-lockfile && \
    yarn download:plugins

# Prepare Swift Application
# Adapted from https://github.com/ls1intum/artemis-swift-swiftlint-docker/blob/main/Dockerfile
FROM ${BUILDER_IMAGE} AS builder

RUN apt-get update && apt-get install -y \
    libcurl4-openssl-dev \
    libxml2-dev \
    && rm -r /var/lib/apt/lists/*

RUN git clone https://github.com/realm/SwiftLint.git
WORKDIR /SwiftLint

# Default SwiftLint version - will be overwritten by the GH action
ARG SWIFTLINT_VERSION=0.53.0
RUN git checkout ${SWIFTLINT_VERSION}

RUN swift package update
ARG SWIFT_FLAGS="-c release -Xswiftc -static-stdlib -Xlinker -lCFURLSessionInterface -Xlinker -lCFXMLInterface -Xlinker -lcurl -Xlinker -lxml2 -Xswiftc -I. -Xlinker -fuse-ld=lld -Xlinker -L/usr/lib/swift/linux"
RUN swift build ${SWIFT_FLAGS} --product swiftlint
RUN mkdir -p /executables
RUN install -v `swift build ${SWIFT_FLAGS} --show-bin-path`/swiftlint /executables

# Assemble the application
FROM ${RUNTIME_IMAGE} AS final-ide

WORKDIR /home/theia

# Copy node from plugin-image as it is required for Theia 
COPY --from=plugin-image /usr/local/bin/node /usr/local/bin/
COPY --from=plugin-image /usr/local/lib/node_modules/ /usr/local/lib/node_modules/
COPY --from=plugin-image /usr/local/lib/node_modules/ /home/theia/node_modules/
COPY --from=plugin-image /home/theia/node_modules/ /home/theia/node_modules/

# Required by Swift
RUN apt-get update && apt-get install -y \
    libcurl4 \
    libxml2 \
    && rm -r /var/lib/apt/lists/*

# Create theia user and directories
# Application will be copied to /home/theia
# Default workspace is located at /home/project
RUN adduser --system --group theia --uid 1001
RUN chmod g+rw /home && \
    mkdir -p /home/project && \
    chown -R theia:theia /home/theia && \
    chown -R theia:theia /home/project

ENV HOME=/home/theia
WORKDIR /home/theia

# Copy application from builder-stage
COPY --from=base-ide --chown=theia:theia /home/theia /home/theia

# Copy additional plugins
COPY --from=plugin-image --chown=theia:theia /home/theia/plugins /home/theia/plugins

# Copy the project configuration files
COPY images/swift/project /home/project

# Copy dependencies from builder image
COPY --from=builder /usr/lib/libsourcekitdInProc.so /usr/lib
COPY --from=builder /usr/lib/swift/linux/libBlocksRuntime.so /usr/lib
COPY --from=builder /usr/lib/swift/linux/libdispatch.so /usr/lib
COPY --from=builder /usr/lib/swift/linux/libswiftCore.so /usr/lib
COPY --from=builder /executables/* /usr/bin

# Create a symbolic link to the node_modules directory
RUN ln -s /home/theia/node_modules /home/theia/applications/browser/node_modules.asar

# Install required tools for terminal usage inside the IDE
RUN apt-get update && \
    apt-get install -y --no-install-recommends zsh curl git ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Print Installed Swift & SwiftLint Version
RUN swift --version
RUN swiftlint version

EXPOSE 3000

# Specify default shell for Theia and the Built-In plugins directory
ENV SHELL=/bin/zsh \
    THEIA_DEFAULT_PLUGINS=local-dir:/home/theia/plugins

# Use installed git instead of dugite
ENV USE_LOCAL_GIT=true

# Switch to Theia user
USER theia

<<<<<<< Updated upstream
# Install Oh My Zsh with essential plugins for better user experience
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended && \
    git clone https://github.com/zsh-users/zsh-autosuggestions ${HOME}/.oh-my-zsh/custom/plugins/zsh-autosuggestions && \
    git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${HOME}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting && \
    sed -i 's/plugins=(git)/plugins=(git zsh-autosuggestions zsh-syntax-highlighting command-not-found colored-man-pages)/' ${HOME}/.zshrc
=======
# Install Oh My Zsh and plugins
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended && \
    git clone https://github.com/zsh-users/zsh-autosuggestions ${HOME}/.oh-my-zsh/custom/plugins/zsh-autosuggestions && \
    git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${HOME}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting

# Copy centralized zsh configuration
COPY --chown=theia:theia configs/zshrc ${HOME}/.zshrc
>>>>>>> Stashed changes
WORKDIR /home/theia/applications/browser

# Launch the backend application via node
ENTRYPOINT [ "node", "/home/theia/applications/browser/lib/backend/main.js" ]

# Arguments passed to the application
CMD [ "/home/project", "--hostname=0.0.0.0" ]