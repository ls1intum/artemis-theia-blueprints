# Load the base-ide image, only copy from here
ARG BASE_IDE_TAG=latest
FROM ghcr.io/ls1intum/theia/base:${BASE_IDE_TAG} AS base-ide

# Load the plugin image, only copy from here
FROM node:22-bullseye AS plugin-image

WORKDIR /home/theia

# Configure to skip download of puppeteer
ENV PUPPETEER_SKIP_DOWNLOAD=true

# Install jq for JSON merging
RUN apt-get update && apt-get install -y --no-install-recommends jq && rm -rf /var/lib/apt/lists/*

# Copy required configuration files
COPY yarn.lock yarn.lock

# Copy base package.json and patch
COPY --from=base-ide /home/theia/package.json ./package.json.base
COPY images/theia-no-ls/package.json.patch ./package.json.patch

# Merge the base package.json with the patch using jq
RUN jq -s '.[0] * .[1]' package.json.base package.json.patch > package.json && \
    rm package.json.base package.json.patch

COPY --from=base-ide /home/theia/plugins /home/theia/plugins
COPY scripts/ /home/theia/scripts/

# Remove unnecessary files for the browser application
# Download plugins and build application production mode
# Use yarn autoclean to remove unnecessary files from package dependencies
RUN yarn --pure-lockfile --network-timeout 1000000 && \
    yarn download:plugins

# Assemble the application
FROM node:22-bullseye-slim AS final-ide

WORKDIR /home/theia

# Create theia user and directories
# Application will be copied to /home/theia
# Default workspace is located at /home/project
RUN adduser --system --group theia --uid 101
RUN chmod g+rw /home && \
    mkdir -p /home/project && \
    chown -R theia:theia /home/theia && \
    chown -R theia:theia /home/project

# Apply LightWeight settings for Java extension
RUN mkdir -p /home/theia/applications/browser/resources/user
COPY images/theia-no-ls/.theia/settings.json /home/theia/applications/browser/resources/user/settings.json
RUN chown -R theia:theia /home/theia/applications/browser/resources/user

# Install required tools for application: Temurin JDK, JDK, SSH, Bash, Maven
# Node is already available in base image
# ADDED: curl and build-essential for Rust support
RUN apt-get update && apt-get install -y wget apt-transport-https && \
    apt-get update && apt-get install -y git openssh-client openssh-server bash libsecret-1-0 openjdk-17-jdk maven curl build-essential && \
    apt-get purge -y wget && \
    apt-get clean

ENV HOME=/home/theia
WORKDIR /home/theia

# Copy application from builder-stage
COPY --from=base-ide --chown=theia:theia /home/theia /home/theia

# Copy additional plugins
COPY --from=plugin-image /home/theia/plugins /home/theia/plugins

# Copy the project configuration files
COPY --from=base-ide --chown=theia:theia /home/theia/project /home/project

EXPOSE 3000

# Specify default shell for Theia and the Built-In plugins directory
ENV SHELL=/bin/bash \
    THEIA_DEFAULT_PLUGINS=local-dir:/home/theia/plugins

# Use installed git instead of dugite
ENV USE_LOCAL_GIT=true

# Switch to Theia user
USER theia

# Install dependencies for this application: Rustup
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs --output rust.sh \
    && chmod +x rust.sh \
    && ./rust.sh -y \
    && rm rust.sh \
    && . "$HOME/.cargo/env" \
    && /home/theia/.cargo/bin/rustup component add rust-analysis rust-src \
    && export PATH="$HOME/.cargo/bin:$PATH"

# Add Rust to the global PATH for all users
ENV PATH=/home/theia/.cargo/bin:$PATH

# Ensure the environment is set correctly when switching to the user "theia"
RUN echo 'source $HOME/.cargo/env' >> /home/theia/.bashrc

WORKDIR /home/theia/applications/browser

# Launch the backend application via node
ENTRYPOINT [ "node", "/home/theia/applications/browser/lib/backend/main.js" ]

# Arguments passed to the application
CMD [ "/home/project", "--hostname=0.0.0.0" ]