# syntax=docker/dockerfile:1
# Dependency installation stage to maximise caching
FROM node:22-bullseye AS install-deps

# Install build prerequisites only once; BuildKit cache mounts keep apt data across builds
RUN --mount=type=cache,id=apt-cache-install-deps,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,id=apt-lib-install-deps,target=/var/lib/apt,sharing=locked \
    apt-get update \
    && apt-get install -y --no-install-recommends libxkbfile-dev libsecret-1-dev jq ca-certificates

WORKDIR /home/theia

# Configure to skip download of puppeteer
ENV PUPPETEER_SKIP_DOWNLOAD=true

# Copy only dependency manifests (including yarn.lock for deterministic installs)
COPY lerna.json ./
COPY yarn.lock ./
COPY package.json ./package.json.base
COPY images/base-ide/package.json.patch ./package.json.patch
COPY applications/browser/package.json applications/browser/
COPY theia-extensions/product/package.json theia-extensions/product/
# Copy scripts needed for plugin download hooks
COPY scripts/ ./scripts/

# Merge the base package.json with the patch using jq
RUN jq -s '.[0] + .[1]' package.json.base package.json.patch > package.json.merged
RUN cp package.json.merged package.json

# Install all workspace dependencies needed for the build (using lockfile for speed + reproducibility)
# Yarn cache mount allows incremental downloads when package.json changes
RUN --mount=type=cache,id=yarn-cache,target=/usr/local/share/.cache/yarn,sharing=locked \
    yarn config set network-timeout 600000 -g \
    && yarn install

# Download plugins early to leverage caching
# This step relies on package.json and scripts/, so it can be cached before source code changes
# Cache mount keeps previously-downloaded .vsix files across builds so only changed plugins
# are re-fetched when the layer is invalidated.  The mount is at a staging path because
# --mount=type=cache contents are NOT persisted into the layer â€” we seed from cache, run the
# download (which skips existing files), then sync back.
RUN --mount=type=cache,id=plugins-base,target=/tmp/plugin-cache,sharing=locked \
    mkdir -p /home/theia/plugins \
    && (cp -a /tmp/plugin-cache/. /home/theia/plugins/ 2>/dev/null || true) \
    && yarn download:plugins \
    && cp -a /home/theia/plugins/. /tmp/plugin-cache/

# Build the browser application (plugins already downloaded in install-deps)
FROM install-deps AS build-stage

# Include the full repository for building
COPY . .
COPY images/base-ide/ .

# Restore the merged package.json (COPY . . overwrote it with the root package.json)
RUN cp package.json.merged package.json
RUN rm package.json.merged package.json.base package.json.patch

# Increase Node.js heap size for build process
ENV NODE_OPTIONS=--max-old-space-size=8192

# Build extensions, download plugins, and produce the browser bundle (browser-only target)
RUN rm -rf applications/electron \
        theia-extensions/launcher \
        theia-extensions/updater \
        theia-extensions/product/src/electron-main \
    && yarn build:extensions \
    && yarn browser build \
    && yarn autoclean --init \
    && echo *.ts >> .yarnclean \
    && echo *.ts.map >> .yarnclean \
    && echo *.spec.* >> .yarnclean \
    && yarn autoclean --force \
    && yarn cache clean \
    && rm -rf .git applications/electron theia-extensions/launcher theia-extensions/updater

# Production dependencies stage - install only runtime dependencies
FROM node:22-bullseye-slim AS prod-deps

WORKDIR /home/theia

# Yarn needs git for dependencies that reference git URLs.
RUN --mount=type=cache,id=apt-cache-prod-deps,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,id=apt-lib-prod-deps,target=/var/lib/apt,sharing=locked \
    apt-get update \
    && apt-get install -y --no-install-recommends git ca-certificates

# Copy package manifests (including yarn.lock for frozen-lockfile)
COPY --from=build-stage /home/theia/package.json /home/theia/lerna.json /home/theia/yarn.lock ./
COPY --from=build-stage /home/theia/applications/browser/package.json applications/browser/
COPY --from=build-stage /home/theia/theia-extensions/product/package.json theia-extensions/product/

# Install ONLY production dependencies
RUN --mount=type=cache,id=yarn-cache,target=/usr/local/share/.cache/yarn,sharing=locked \
    yarn install --production --ignore-scripts --network-timeout 600000

# Final runtime stage
FROM node:22-bullseye-slim AS base-ide

# Install only the libraries required at runtime
RUN --mount=type=cache,id=apt-cache-base-ide,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,id=apt-lib-base-ide,target=/var/lib/apt,sharing=locked \
    apt-get update \
    && apt-get install -y --no-install-recommends libsecret-1-0 libxkbfile1

WORKDIR /home/theia

# Copy the built artefacts and configuration from the build stage
COPY --from=build-stage /home/theia/applications /home/theia/applications
COPY --from=build-stage /home/theia/plugins /home/theia/plugins
COPY --from=build-stage /home/theia/theia-extensions /home/theia/theia-extensions
COPY --from=build-stage /home/theia/package.json /home/theia/package.json
COPY --from=build-stage /home/theia/scripts /home/theia/scripts
COPY --from=build-stage /home/theia/configs /home/theia/configs
COPY --from=build-stage /home/theia/tsconfig.json /home/theia/tsconfig.json
COPY --from=build-stage /home/theia/project /home/theia/project

# Copy production-only node_modules
COPY --from=prod-deps /home/theia/node_modules /home/theia/node_modules
