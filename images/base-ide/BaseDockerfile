# Dependency installation stage to maximise caching
FROM node:22-bullseye AS install-deps

# Install build prerequisites only once and clean up afterwards
ARG APT_HTTP_PROXY
RUN if [ -n "$APT_HTTP_PROXY" ]; then \
      echo "Acquire::http::Proxy \"$APT_HTTP_PROXY\";" > /etc/apt/apt.conf.d/01proxy; \
      sed -i 's|https://|http://|g' /etc/apt/sources.list.d/*.sources 2>/dev/null || true; \
      sed -i 's|https://|http://|g' /etc/apt/sources.list 2>/dev/null || true; \
    fi \
    && apt-get update \
    && apt-get install -y --no-install-recommends libxkbfile-dev libsecret-1-dev jq ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /home/theia

# Configure to skip download of puppeteer
ENV PUPPETEER_SKIP_DOWNLOAD=true

# Install proxy CA certificate for SSL-bump proxy caching (only when using HTTPS_PROXY)
ARG HTTPS_PROXY
ARG https_proxy
COPY certs/squid-proxy-ca.crt /tmp/squid-proxy-ca.crt
RUN if [ -n "${HTTPS_PROXY:-$https_proxy}" ]; then \
      cp /tmp/squid-proxy-ca.crt /usr/local/share/ca-certificates/squid-proxy-ca.crt \
      && update-ca-certificates \
      && echo "Proxy CA certificate installed for SSL-bump proxy"; \
    fi \
    && rm -f /tmp/squid-proxy-ca.crt

# Configure HTTPS proxy for yarn/node (for extension downloads)
ENV HTTPS_PROXY=${HTTPS_PROXY:-$https_proxy}
ENV https_proxy=${HTTPS_PROXY:-$https_proxy}
ENV HTTP_PROXY=${HTTPS_PROXY:-$https_proxy}
ENV http_proxy=${HTTPS_PROXY:-$https_proxy}
# Node.js respects NODE_EXTRA_CA_CERTS for custom CA certificates
ENV NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt

# Copy only dependency manifests
COPY lerna.json ./
COPY package.json ./package.json.base
COPY images/base-ide/package.json.patch ./package.json.patch
COPY applications/browser/package.json applications/browser/
COPY theia-extensions/product/package.json theia-extensions/product/

# Merge the base package.json with the patch using jq
RUN jq -s '.[0] + .[1]' package.json.base package.json.patch > package.json.merged
RUN cp package.json.merged package.json

# Install all workspace dependencies needed for the build
ARG NPM_REGISTRY
RUN yarn config set network-timeout 600000 -g \
    && if [ -n "$NPM_REGISTRY" ]; then yarn config set registry "$NPM_REGISTRY"; fi \
    && yarn install

# Build the browser application and download plugins
FROM install-deps AS build-stage

# Include the full repository for building
COPY . .
COPY images/base-ide/ .

# Restore the merged package.json (COPY . . overwrote it with the root package.json)
RUN cp package.json.merged package.json
RUN rm package.json.merged package.json.base package.json.patch

# Increase Node.js heap size for build process
ENV NODE_OPTIONS=--max-old-space-size=8192

# Build extensions, download plugins, and produce the browser bundle (browser-only target)
RUN rm -rf applications/electron \
        theia-extensions/launcher \
        theia-extensions/updater \
        theia-extensions/product/src/electron-main \
    && yarn build:extensions \
    && yarn download:plugins \
    && yarn browser build \
    && yarn autoclean --init \
    && echo *.ts >> .yarnclean \
    && echo *.ts.map >> .yarnclean \
    && echo *.spec.* >> .yarnclean \
    && yarn autoclean --force \
    && yarn cache clean \
    && rm -rf .git applications/electron theia-extensions/launcher theia-extensions/updater

# Production dependencies stage - install only runtime dependencies
FROM node:22-bullseye-slim AS prod-deps

WORKDIR /home/theia

# Copy package manifests
COPY --from=build-stage /home/theia/package.json /home/theia/lerna.json ./
COPY --from=build-stage /home/theia/applications/browser/package.json applications/browser/
COPY --from=build-stage /home/theia/theia-extensions/product/package.json theia-extensions/product/

# Install ONLY production dependencies
RUN yarn install --production --frozen-lockfile --ignore-scripts --network-timeout 600000

# Final runtime stage
FROM node:22-bullseye-slim AS base-ide

# Install only the libraries required at runtime
ARG APT_HTTP_PROXY
RUN if [ -n "$APT_HTTP_PROXY" ]; then \
      echo "Acquire::http::Proxy \"$APT_HTTP_PROXY\";" > /etc/apt/apt.conf.d/01proxy; \
      sed -i 's|https://|http://|g' /etc/apt/sources.list.d/*.sources 2>/dev/null || true; \
      sed -i 's|https://|http://|g' /etc/apt/sources.list 2>/dev/null || true; \
    fi \
    && apt-get update \
    && apt-get install -y --no-install-recommends libsecret-1-0 libxkbfile1 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /home/theia

# Copy the built artefacts and configuration from the build stage
COPY --from=build-stage /home/theia/applications /home/theia/applications
COPY --from=build-stage /home/theia/plugins /home/theia/plugins
COPY --from=build-stage /home/theia/theia-extensions /home/theia/theia-extensions
COPY --from=build-stage /home/theia/package.json /home/theia/package.json
COPY --from=build-stage /home/theia/scripts /home/theia/scripts
COPY --from=build-stage /home/theia/configs /home/theia/configs
COPY --from=build-stage /home/theia/tsconfig.json /home/theia/tsconfig.json
COPY --from=build-stage /home/theia/project /home/theia/project

# Copy production-only node_modules
COPY --from=prod-deps /home/theia/node_modules /home/theia/node_modules
