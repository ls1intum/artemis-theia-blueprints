# Dependency installation stage to maximise caching
FROM node:22-bullseye AS install-deps

# Install build prerequisites only once and clean up afterwards
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update \
    && apt-get install -y --no-install-recommends libxkbfile-dev libsecret-1-dev jq \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /home/theia

# Configure to skip download of puppeteer
ENV PUPPETEER_SKIP_DOWNLOAD=true

# Copy only dependency manifests
COPY lerna.json ./
COPY package.json ./package.json.base
COPY images/base-ide/package.json.patch ./package.json.patch
COPY applications/browser/package.json applications/browser/
COPY theia-extensions/product/package.json theia-extensions/product/
COPY yarn.lock ./

# Merge the base package.json with the patch using jq
RUN jq -s '.[0] + .[1]' package.json.base package.json.patch > package.json.merged
RUN cp package.json.merged package.json

# Install all workspace dependencies needed for the build
RUN --mount=type=cache,target=/usr/local/share/.cache/yarn \
    yarn config set network-timeout 600000 -g \
    && yarn install --frozen-lockfile

# Prepare for plugin download (cacheable step)
COPY configs/ ./configs/
COPY scripts/ ./scripts/
COPY tsconfig.json ./

# Download plugins before full source copy to cache this layer
# Note: Parallel download is enabled in package.json. If rate limits occur, set --parallel=false there.
RUN yarn download:plugins

# Build the browser application and download plugins
FROM install-deps AS build-stage

# Include the full repository for building
COPY . .
COPY images/base-ide/ .

# Restore the merged package.json (COPY . . overwrote it with the root package.json)
RUN cp package.json.merged package.json
RUN rm package.json.merged package.json.base package.json.patch

# Increase Node.js heap size for build process
ENV NODE_OPTIONS=--max-old-space-size=8192

# Build extensions, download plugins, and produce the browser bundle (browser-only target)
RUN rm -rf applications/electron \
        theia-extensions/launcher \
        theia-extensions/updater \
        theia-extensions/product/src/electron-main \
    && yarn build:extensions \
    && yarn browser build \
    && yarn autoclean --init \
    && echo *.ts >> .yarnclean \
    && echo *.ts.map >> .yarnclean \
    && echo *.spec.* >> .yarnclean \
    && yarn autoclean --force \
    && yarn cache clean \
    && rm -rf .git applications/electron theia-extensions/launcher theia-extensions/updater

# Production dependencies stage - install only runtime dependencies
FROM node:22-bullseye-slim AS prod-deps

WORKDIR /home/theia

# Copy package manifests
COPY --from=build-stage /home/theia/package.json /home/theia/lerna.json ./
COPY --from=build-stage /home/theia/applications/browser/package.json applications/browser/
COPY --from=build-stage /home/theia/theia-extensions/product/package.json theia-extensions/product/
COPY yarn.lock ./

# Install ONLY production dependencies
RUN --mount=type=cache,target=/usr/local/share/.cache/yarn \
    yarn install --production --frozen-lockfile --ignore-scripts --network-timeout 600000

# Final runtime stage
FROM node:22-bullseye-slim AS base-ide

# Install only the libraries required at runtime
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update \
    && apt-get install -y --no-install-recommends libsecret-1-0 libxkbfile1 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /home/theia

# Copy the built artefacts and configuration from the build stage
COPY --from=build-stage /home/theia/applications /home/theia/applications
COPY --from=build-stage /home/theia/plugins /home/theia/plugins
COPY --from=build-stage /home/theia/theia-extensions /home/theia/theia-extensions
COPY --from=build-stage /home/theia/package.json /home/theia/package.json
COPY --from=build-stage /home/theia/scripts /home/theia/scripts
COPY --from=build-stage /home/theia/configs /home/theia/configs
COPY --from=build-stage /home/theia/tsconfig.json /home/theia/tsconfig.json
COPY --from=build-stage /home/theia/project /home/theia/project

# Copy production-only node_modules
COPY --from=prod-deps /home/theia/node_modules /home/theia/node_modules
# Trigger build Tue Jan 20 13:57:46 CET 2026
