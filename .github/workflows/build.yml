name: Build and Push Theia Images

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master
  release:
  workflow_dispatch:

jobs:
  # Check if base-ide related files have changed
  check-base-changes:
    runs-on: ubuntu-latest
    outputs:
      base-changed: ${{ steps.filter.outputs.base }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for base-ide changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            base:
              - 'images/base-ide/**'
              - 'package.json'
              - 'yarn.lock'
              - 'lerna.json'
              - 'applications/browser/package.json'
              - 'applications/browser/**/*.ts'
              - 'applications/browser/**/*.tsx'
              - 'theia-extensions/product/package.json'
              - 'theia-extensions/product/**/*.ts'
              - 'theia-extensions/product/**/*.tsx'
              - 'configs/**'
              - 'scripts/**'
              - 'tsconfig.json'

  determine-tag:
    runs-on: ubuntu-latest
    needs: check-base-changes
    outputs:
      base_tag: ${{ steps.set-tag.outputs.base_tag }}
      sha_tag: ${{ steps.set-tag.outputs.sha_tag }}
      cache_tag: ${{ steps.set-tag.outputs.cache_tag }}
    steps:
      - name: Checkout for SHA access
        uses: actions/checkout@v4

      - name: Set tags
        id: set-tag
        run: |
          SHORT_SHA=$(git rev-parse --short=7 HEAD)
          REF_NAME="${{ github.ref_name }}"
          # Sanitize ref name for Docker tag compatibility (lowercase, replace invalid chars with -)
          SAFE_REF_NAME=$(echo "$REF_NAME" | tr '[:upper:]' '[:lower:]' | tr -c 'a-z0-9_.-' '-')
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_TAG="pr-${{ github.event.pull_request.number }}"
            CACHE_TAG="build-cache-pr-${{ github.event.pull_request.number }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            BASE_TAG="latest"
            CACHE_TAG="build-cache"
          else
            # For workflow_dispatch or push on feature branches
            BASE_TAG="${SAFE_REF_NAME}"
            CACHE_TAG="build-cache-${SAFE_REF_NAME}"
          fi
          
          echo "base_tag=${BASE_TAG}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=${BASE_TAG}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "cache_tag=${CACHE_TAG}" >> "$GITHUB_OUTPUT"

  build-and-push-base:
    needs:
      - determine-tag
      - check-base-changes
    # Performance Test #1: Always build base (no conditional skip)
    if: always()
    uses: ls1intum/.github/.github/workflows/build-and-push-docker-image.yml@feature/arc-runner-support
    with:
      docker-file: images/base-ide/BaseDockerfile
      image-name: ls1intum/theia/base
      docker-context: .
      tags: |
        ${{ needs.determine-tag.outputs.base_tag }}
        ${{ needs.determine-tag.outputs.sha_tag }}
      network: "host"
      runner-amd64: ubuntu-24.04
      runner-arm64: ubuntu-24.04-arm
    secrets: inherit

  determine-tool-tag:
    runs-on: ubuntu-latest
    needs:
      - determine-tag
      - build-and-push-base
      - check-base-changes
    # Always run this job, even if build-and-push-base was skipped
    if: always()
    outputs:
      base_tag_for_tools: ${{ steps.set-tool-tag.outputs.base_tag_for_tools }}
    steps:
      - name: Determine base tag for tool images
        id: set-tool-tag
        run: |
          BASE_TAG="${{ needs.determine-tag.outputs.base_tag }}"
          
          # If base was built and pushed, use the PR/branch tag
          if [[ "${{ needs.build-and-push-base.result }}" == "success" ]]; then
            echo "✅ Base image was built and pushed, tool images will use: ${BASE_TAG}"
            echo "base_tag_for_tools=${BASE_TAG}" >> "$GITHUB_OUTPUT"
          # If base build was skipped but base was changed, check registry
          elif [[ "${{ needs.check-base-changes.outputs.base-changed }}" == "true" ]] && [[ "${{ needs.build-and-push-base.result }}" == "skipped" ]]; then
            # This shouldn't happen due to workflow conditions, but handle it safely
            echo "⚠️ Base changed but build was skipped - checking registry"
            if docker manifest inspect ghcr.io/ls1intum/theia/base:${BASE_TAG} > /dev/null 2>&1; then
              echo "✅ Tag ${BASE_TAG} exists in registry"
              echo "base_tag_for_tools=${BASE_TAG}" >> "$GITHUB_OUTPUT"
            else
              echo "⚠️ Tag ${BASE_TAG} not found, falling back to latest"
              echo "base_tag_for_tools=latest" >> "$GITHUB_OUTPUT"
            fi
          # Base was not changed, check if tag exists in registry
          else
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              # For PRs where base didn't change, check registry
              if docker manifest inspect ghcr.io/ls1intum/theia/base:${BASE_TAG} > /dev/null 2>&1; then
                echo "✅ PR tag ${BASE_TAG} exists in registry (from previous build)"
                echo "base_tag_for_tools=${BASE_TAG}" >> "$GITHUB_OUTPUT"
              else
                echo "ℹ️ Base unchanged and PR tag not in registry, using latest"
                echo "base_tag_for_tools=latest" >> "$GITHUB_OUTPUT"
              fi
            else
              # For master/main or branches, use the determined tag
              echo "ℹ️ Base unchanged, using tag: ${BASE_TAG}"
              echo "base_tag_for_tools=${BASE_TAG}" >> "$GITHUB_OUTPUT"
            fi
          fi

  build-and-push:
    needs:
      - determine-tag
      - determine-tool-tag
    strategy:
      fail-fast: false
      matrix:
        include:
          - docker-file: images/c/ToolDockerfile
            docker-context: "."
            image-name: ls1intum/theia/c
          - docker-file: images/haskell/ToolDockerfile
            docker-context: "."
            image-name: ls1intum/theia/haskell
          - docker-file: images/java-17/ToolDockerfile
            docker-context: "."
            image-name: ls1intum/theia/java-17
          - docker-file: images/javascript/ToolDockerfile
            docker-context: "."
            image-name: ls1intum/theia/javascript
          - docker-file: images/ocaml/ToolDockerfile
            docker-context: "."
            image-name: ls1intum/theia/ocaml
          - docker-file: images/python/ToolDockerfile
            docker-context: "."
            image-name: ls1intum/theia/python
          - docker-file: images/rust/ToolDockerfile
            docker-context: "."
            image-name: ls1intum/theia/rust

    uses: ls1intum/.github/.github/workflows/build-and-push-docker-image.yml@feature/arc-runner-support
    with:
      docker-file: ${{ matrix.docker-file }}
      image-name: ${{ matrix.image-name }}
      docker-context: ${{ matrix.docker-context }}
      build-args: |
        BASE_IDE_TAG=${{ needs.determine-tool-tag.outputs.base_tag_for_tools }}
      tags: |
        ${{ needs.determine-tag.outputs.base_tag }}
        ${{ needs.determine-tag.outputs.sha_tag }}
      network: "host"
      runner-amd64: ubuntu-24.04
      runner-arm64: ubuntu-24.04-arm
    secrets: inherit
